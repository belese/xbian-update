#!/bin/bash

if [ $1 == "configure" ]; then

	echo "1.0Beta1.1" > /etc/xbian_version
	
	insserv /etc/init.d/rpcbind
	insserv /etc/init.d/nfs-common

	chown -Rc xbian:xbian /home/xbian
	cp -a --remove-destination /var/tmp/etc/profiles /etc/profiles
	cp -a --remove-destination /var/tmp/default/nfs-common /etc/default/nfs-common
	locale-gen

	if [ ! -e /tmp/xbian-update-reboot ]; then
cat << \EOF > /tmp/xbian-update-reboot
#!/bin/sh

while { pgrep dpkg >/dev/null|| pgrep apt-get >/dev/null; } ; do sleep 5; done
/usr/bin/splash --infinitebar --msgtxt="stopping services..."
for f in $(ls /etc/rc2.d/S* | sort -r); do
	[ -x $f ] && $f stop
done
apt-get clean
sleep 5
sync
/usr/bin/splash --infinitebar --msgtxt="rebooting..."
reboot -f

EOF

		chmod +x /tmp/xbian-update-reboot >/dev/null 2>&1
		/tmp/xbian-update-reboot &
	fi

fi

mountpoint -q /boot && umount /boot || true

exit 0
