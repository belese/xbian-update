#!/bin/bash

if [ $1 == "configure" ]; then

	echo "1.0Beta1.1" > /etc/xbian_version
	
	insserv /etc/init.d/rpcbind
	insserv /etc/init.d/nfs-common
	insserv -rf /etc/init.d/avahi-daemon
	insserv -rf /etc/init.d/dbus
	insserv -d

	chown -Rc xbian:xbian /home/xbian
	cp -a --remove-destination /var/tmp/etc/profile /etc/profile
	cp -a --remove-destination /var/tmp/default/nfs-common /etc/default/nfs-common
	locale-gen

	cd /usr/share/polkit-1/actions

cat << \EOF > /tmp/udisks.patch  
--- org.freedesktop.udisks.policy       2012-08-01 00:00:00.000000000 +0200
+++ org.freedesktop.udisks.policy.new   2013-06-30 20:10:16.000000000 +0200
@@ -81,7 +81,7 @@
     <message xml:lang="de">Zugriffsrechte werden benötigt um ein Gerät auszuhängen, das ein anderer Benutzer eingehängt hat</message>
     <message xml:lang="pt_BR">Autenticação é requerida para desmontar dispositivos montados por um outro usuário</message>
     <defaults>
-      <allow_any>no</allow_any>
+      <allow_any>yes</allow_any>
       <allow_inactive>no</allow_inactive>
       <allow_active>auth_admin</allow_active>
     </defaults>
EOF

	if patch -N --dry-run ./org.freedesktop.udisks.policy < /tmp/udisks.patch > /dev/null 2>&1; then
	    patch -s ./org.freedesktop.udisks.policy < /tmp/udisks.patch
	else
	    echo "Patch failed!"
	fi
	rm -fr /tmp/udisks.patch

	if [ ! -e /tmp/xbian-update-reboot ]; then
cat << \EOF > /tmp/xbian-update-reboot
#!/bin/sh

while { pgrep dpkg >/dev/null|| pgrep apt-get >/dev/null; } ; do sleep 5; done
/usr/bin/splash --infinitebar --msgtxt="stopping services..."
for f in $(ls /etc/rc2.d/S* | sort -r); do
	[ -x $f ] && $f stop
done
apt-get clean
sleep 5
sync
/usr/bin/splash --infinitebar --msgtxt="rebooting..."
reboot -f

EOF

		chmod +x /tmp/xbian-update-reboot >/dev/null 2>&1
		/tmp/xbian-update-reboot &
	fi

fi

mountpoint -q /boot && umount /boot || true

exit 0
