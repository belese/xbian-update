#!/bin/bash

mountpoint -q /boot || mount /boot

if [ $1 == "install" ]; then

	if [ $(dpkg-query -W -f='${Version}\n' "xbian-update") != "1.0-1" -a $(dpkg-query -W -f='${Version}\n' "xbian-update") != "1.0-1.2" ]; then
		echo "!-------------------------------------------------!"
		echo "!                                                 !"
		echo "! Please install this update on XBian 1.0 Beta 1 !"
		echo "!                                                 !"
		echo "!-------------------------------------------------!"
#		exit 1;
	fi

fi

if [ $1 == "upgrade" ]; then

	if [ $(dpkg-query -W -f='${Version}\n' "xbian-update") != "1.0-1" -a $(dpkg-query -W -f='${Version}\n' "xbian-update") != “1.0-1.1” ]; then
		echo "!-------------------------------------------------!"
		echo "!                                                 !"
		echo "! Please install this update on XBian 1.0 Beta 1  !"
		echo "!    or use it to reinstall XBian 1.0 Beta 1.1      !"
		echo "!                                                 !"
		echo "!-------------------------------------------------!"
#		exit 1;
	fi

fi

if [ $1 == "install" -o $1 == "upgrade" ]; then

	echo "1) Stopping XBMC";
	stop xbmc >/dev/null 2>&1|| service xbmc stop >/dev/null 2>&1||true

	echo "2) Installing new files"
	/usr/bin/splash --infinitebar --msgtxt="installing update..."
	
	if [ -f "/boot/cmdline.txt" ]; then
       		mv /boot/cmdline.txt /boot/cmdline.txt.old
	fi
	
fi
