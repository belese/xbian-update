#!/bin/bash

{ mountpoint -q /boot && [ "$(findmnt -o source -n /boot)" = '/dev/mmcblk0p1' ]; } || { umount /boot >/dev/null 2>&1; mount -t vfat /dev/mmcblk0p1 /boot || { echo "CAN'T MOUNT BOOT"; exit 1; }; }

if [ $1 == "install" -o $1 == "upgrade" ]; then

        sed -i 's/^initramfs /#initramfs /' /boot/config.txt

        if ! pgrep xbmc.bin > /dev/null && [ "$(grep -c . /run/lock/xbian-config.gui 2>/dev/null)" -eq 0 ]; then

            pkill splash || :

            /usr/bin/splash --infinitebar --msgtxt="installing update..." &
        else
            touch /run/noreboot
        fi

	if [ -f "/boot/cmdline.txt" ]; then
		mv /boot/cmdline.txt /boot/cmdline.txt.old
	fi
	[ ! -e "/boot/cmdline.new" ] || rm -f /boot/cmdline.new

	[ ! -e /etc/xbian_revision ] || cp /etc/xbian_revision /tmp/xbian_revision.old

        if [ ! -e /etc/samba/smb.conf.xbian ]; then
            mv /etc/samba/smb.conf /etc/samba/smb.conf.xbian
        fi
fi
